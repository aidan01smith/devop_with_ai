---
# Theme 03: Audit and Logging Configuration
# This playbook configures comprehensive logging and auditing
# across Windows and Linux environments

- name: Windows Audit and Logging Configuration
  hosts: windows
  gather_facts: yes
  tasks:
    # System Administration - Configure Event Log Settings
    - name: Configure Windows Event Log Settings
      win_shell: |
        # Configure Application log
        wevtutil sl Application /ms:102400000
        # Configure System log
        wevtutil sl System /ms:102400000
        # Configure Security log (larger size)
        wevtutil sl Security /ms:204800000
      register: event_log_config
      tags:
        - event_logs
        - system_admin

    - name: Display Event Log Configuration Results
      debug:
        var: event_log_config
      when: event_log_config is defined
      tags:
        - event_logs
        - debug

    # System Administration - Configure Windows Powershell Logging
    - name: Enable PowerShell Script Block Logging
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
        name: EnableScriptBlockLogging
        data: 1
        type: dword
        state: present
      tags:
        - powershell_logging
        - system_admin

    - name: Enable PowerShell Module Logging
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging
        name: EnableModuleLogging
        data: 1
        type: dword
        state: present
      tags:
        - powershell_logging
        - system_admin

    # System Hardening - Enable AppLocker Audit Mode
    - name: Create AppLocker Registry Keys
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\SrpV2\{{ item }}
        state: present
      loop:
        - Exe
        - Dll
        - Script
        - Msi
        - Appx
      tags:
        - applocker
        - hardening

    - name: Configure AppLocker Default Rules in Audit Mode
      win_shell: |
        # Create AppLocker default rules in audit mode
        powershell -ExecutionPolicy Bypass -Command "& {
          Import-Module AppLocker
          Set-AppLockerPolicy -XmlPolicy C:\Windows\schemas\CodeIntegrity\ExamplePolicies\DefaultAppLockerPolicy.xml -Audit -Merge
        }"
      ignore_errors: yes  # Continue if AppLocker is not available
      tags:
        - applocker
        - hardening

    # System Hardening - Security Auditing Configuration
    - name: Configure Advanced Security Audit Policy
      win_shell: |
        # Account Logon
        auditpol /set /subcategory:"Credential Validation" /success:enable /failure:enable
        auditpol /set /subcategory:"Kerberos Authentication Service" /success:enable /failure:enable
        
        # Account Management
        auditpol /set /subcategory:"User Account Management" /success:enable /failure:enable
        auditpol /set /subcategory:"Security Group Management" /success:enable /failure:enable
        
        # Detailed Tracking
        auditpol /set /subcategory:"Process Creation" /success:enable /failure:enable
        
        # Logon/Logoff
        auditpol /set /subcategory:"Logon" /success:enable /failure:enable
        auditpol /set /subcategory:"Logoff" /success:enable /failure:enable
        auditpol /set /subcategory:"Account Lockout" /success:enable /failure:enable
        auditpol /set /subcategory:"Special Logon" /success:enable /failure:enable
        
        # Object Access
        auditpol /set /subcategory:"File System" /success:enable /failure:enable
        auditpol /set /subcategory:"Registry" /success:enable /failure:enable
        
        # Policy Change
        auditpol /set /subcategory:"Audit Policy Change" /success:enable /failure:enable
        
        # Privilege Use
        auditpol /set /subcategory:"Sensitive Privilege Use" /success:enable /failure:enable
        
        # System
        auditpol /set /subcategory:"Security State Change" /success:enable /failure:enable
        auditpol /set /subcategory:"Security System Extension" /success:enable /failure:enable
      register: audit_policy
      tags:
        - security_audit
        - hardening

    - name: Display Audit Policy Configuration
      debug:
        var: audit_policy
      when: audit_policy is defined
      tags:
        - security_audit
        - debug

    # AD DS GPO Hardening - Event Log Settings via Registry
    - name: Configure Event Log Retention via Registry (GPO Simulation)
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\{{ item.logname }}
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: "{{ item.type }}"
      loop:
        - { logname: "Application", name: "Retention", data: "0", type: "string" }  # Never overwrite events
        - { logname: "Security", name: "Retention", data: "0", type: "string" }     # Never overwrite events
        - { logname: "System", name: "Retention", data: "0", type: "string" }       # Never overwrite events
        - { logname: "Application", name: "MaxSize", data: "102400000", type: "dword" }  # 100 MB
        - { logname: "Security", name: "MaxSize", data: "204800000", type: "dword" }     # 200 MB
        - { logname: "System", name: "MaxSize", data: "102400000", type: "dword" }       # 100 MB
      tags:
        - gpo
        - event_log_policy

    # AD DS GPO Hardening - Account Auditing Policy via Registry
    - name: Configure Account Lockout Policy via Registry
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: "{{ item.type }}"
      loop:
        - { name: "LockoutThreshold", data: 5, type: dword }         # 5 failed attempts
        - { name: "LockoutDuration", data: 30, type: dword }         # 30 minutes
        - { name: "ResetLockoutCount", data: 30, type: dword }       # 30 minutes window
      when: inventory_hostname == "AD01"  # Only for DC
      tags:
        - gpo
        - lockout_policy

    # AD DS GPO Hardening - Configure Audit Object Access via Registry
    - name: Configure Advanced Audit Policy via Registry
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: "{{ item.type }}"
      loop:
        - { name: "ProcessCreationIncludeCmdLine_Enabled", data: 1, type: dword }  # Log command line in process creation events
      tags:
        - gpo
        - advanced_audit_policy

- name: Rocky Linux Audit and Logging Configuration
  hosts: rocky
  become: yes
  gather_facts: yes
  vars:
    rsyslog_server: "192.168.1.100"  # Example log server IP (adjust as needed)
  tasks:
    # System Administration - Configure rsyslog
    - name: Install rsyslog if not present
      dnf:
        name: rsyslog
        state: present
      tags:
        - rsyslog
        - system_admin

    - name: Configure rsyslog with enhanced logging
      copy:
        dest: /etc/rsyslog.d/security-enhanced.conf
        content: |
          # Enhanced Security Logging Configuration
          # Log auth messages at a higher level
          auth,authpriv.*                      /var/log/secure
          # Log all kernel messages
          kern.*                               /var/log/kernel
          # Log all mail messages
          mail.*                               /var/log/maillog
          # Log cron jobs
          cron.*                               /var/log/cron
          # Log all error messages or higher to a special file
          *.err                                /var/log/errors
          # Example forwarding - uncomment if using centralized logging
          # *.* @{{ rsyslog_server }}:514
      notify: Restart rsyslog
      tags:
        - rsyslog
        - system_admin

    - name: Configure log rotation
      copy:
        dest: /etc/logrotate.d/security-logs
        content: |
          /var/log/secure /var/log/kernel /var/log/maillog /var/log/cron /var/log/errors {
              rotate 14
              daily
              compress
              delaycompress
              missingok
              notifempty
              create 0600 root root
              sharedscripts
              postrotate
                  systemctl restart rsyslog >/dev/null 2>&1 || true
              endscript
          }
      tags:
        - logrotate
        - system_admin

    # System Administration - Configure auditd Rules
    - name: Install audit package
      dnf:
        name: audit
        state: present
      tags:
        - auditd
        - system_admin

    - name: Configure auditd service
      copy:
        dest: /etc/audit/auditd.conf
        content: |
          # auditd configuration
          log_file = /var/log/audit/audit.log
          log_format = RAW
          log_group = root
          priority_boost = 4
          freq = 20
          num_logs = 5
          disp_qos = lossy
          dispatcher = /sbin/audispd
          name_format = NONE
          max_log_file = 100
          max_log_file_action = keep_logs
          space_left = 75
          space_left_action = SYSLOG
          admin_space_left = 50
          admin_space_left_action = SYSLOG
          disk_full_action = SUSPEND
          disk_error_action = SUSPEND
          flush = INCREMENTAL_ASYNC
          freq = 50
      notify: Restart auditd
      tags:
        - auditd
        - system_admin

    # System Hardening - Configure Basic Audit Rules
    - name: Configure basic audit rules
      copy:
        dest: /etc/audit/rules.
